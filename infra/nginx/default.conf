server {
  listen 80;
  server_name _;

  # Re-resolve Docker DNS names periodically so upstream container IP changes
  # (e.g. `docker compose up --force-recreate`) don't cause long-lived 502s.
  resolver 127.0.0.11 ipv6=off valid=10s;
  set $api_upstream api:8000;
  set $web_upstream web:3000;

  # Convenience: allow API access without the /api prefix as well.
  # This also makes Swagger "Try it out" resilient if the server URL is miscomputed client-side.
  location = /openapi.json {
    proxy_pass http://$api_upstream/openapi.json$is_args$args;
    proxy_set_header Host $host;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-User $http_x_forwarded_user;
  }

  location = /docs {
    proxy_pass http://$api_upstream/docs$is_args$args;
    proxy_set_header Host $host;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-User $http_x_forwarded_user;
  }

  location /v1/ {
    proxy_pass http://$api_upstream$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-User $http_x_forwarded_user;
  }

  location /health {
    proxy_pass http://$api_upstream$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-User $http_x_forwarded_user;
  }

  location /api/ {
    rewrite ^/api(/.*)$ $1 break;
    proxy_pass http://$api_upstream$uri$is_args$args;
    proxy_set_header Host $host;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-User $http_x_forwarded_user;
  }

  location / {
    proxy_pass http://$web_upstream$request_uri;
    proxy_set_header Host $host;
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Forwarded-User $http_x_forwarded_user;
  }
}
